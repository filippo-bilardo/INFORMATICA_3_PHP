## **2.2 Connessione al Database con MySQLi**

MySQLi (Improved MySQL) è un'estensione PHP specifica per interagire con database MySQL/MariaDB. Offre due stili di programmazione: **procedurale** e **orientato agli oggetti (OO)**. Inoltre, supporta funzionalità avanzate come prepared statements, transazioni e gestione degli errori.

---

### **Caratteristiche Chiave di MySQLi**
- Supporto per MySQL/MariaDB.
- Due modi per scrivere il codice: procedurale e orientato agli oggetti.
- Prepared statements per prevenire attacchi di SQL injection.
- Gestione delle transazioni.
- Ottimizzato per prestazioni elevate.

---

### **Connessione Procedurale**

Il modo procedurale utilizza funzioni per interagire con il database. È semplice da imparare e adatto a chi ha familiarità con lo stile imperativo.

#### **Esempio di Connessione Procedurale:**
```php
<?php
// Parametri di connessione
$host = "localhost";
$username = "root";
$password = "";
$database = "testdb";

// Tentativo di connessione
$conn = mysqli_connect($host, $username, $password, $database);

// Verifica della connessione
if (!$conn) {
    die("Connessione fallita: " . mysqli_connect_error());
}

echo "Connessione riuscita!";
mysqli_close($conn); // Chiusura della connessione
?>
```

#### **Spiegazione del Codice:**
1. `mysqli_connect()` tenta di stabilire una connessione al database usando i parametri forniti.
2. `mysqli_connect_error()` restituisce un messaggio di errore in caso di fallimento.
3. `mysqli_close()` chiude la connessione quando non è più necessaria.

---

### **Connessione Orientata agli Oggetti**

Lo stile orientato agli oggetti utilizza classi e oggetti per interagire con il database. È più moderno e flessibile rispetto allo stile procedurale.

#### **Esempio di Connessione Orientata agli Oggetti:**
```php
<?php
// Parametri di connessione
$host = "localhost";
$username = "root";
$password = "";
$database = "testdb";

try {
    // Creazione dell'oggetto di connessione
    $conn = new mysqli($host, $username, $password, $database);

    // Verifica della connessione
    if ($conn->connect_error) {
        throw new Exception("Connessione fallita: " . $conn->connect_error);
    }

    echo "Connessione riuscita!";
} catch (Exception $e) {
    echo "Errore: " . $e->getMessage();
} finally {
    // Chiusura della connessione
    if ($conn) {
        $conn->close();
    }
}
?>
```

#### **Spiegazione del Codice:**
1. `new mysqli()` crea un'istanza della classe `mysqli` per la connessione.
2. `$conn->connect_error` verifica se ci sono errori durante la connessione.
3. L'uso di `try-catch` permette di gestire gli errori in modo strutturato.
4. Il blocco `finally` garantisce che la connessione venga chiusa correttamente.

---

### **Gestione degli Errori**

MySQLi offre diversi modi per gestire gli errori:
- **Procedurale:** Utilizzo di `mysqli_connect_error()` o `mysqli_error()`.
- **Orientato agli Oggetti:** Utilizzo di proprietà come `$conn->connect_error` o metodi come `$conn->error`.

#### **Esempio di Gestione degli Errori:**
```php
<?php
$host = "localhost";
$username = "root";
$password = "password_sbagliata"; // Password errata per dimostrare l'errore
$database = "testdb";

$conn = new mysqli($host, $username, $password, $database);

if ($conn->connect_error) {
    echo "Errore di connessione: " . $conn->connect_error;
} else {
    echo "Connessione riuscita!";
    $conn->close();
}
?>
```

---

### **Best Practice per la Sicurezza**

Quando si lavora con MySQLi, è importante seguire alcune best practice per garantire la sicurezza:

1. **Non Hard-Codare le Credenziali:**
   - Usa variabili d'ambiente o file di configurazione separati per memorizzare le credenziali del database.
   - Esempio:
     ```php
     $host = getenv('DB_HOST');
     $username = getenv('DB_USER');
     $password = getenv('DB_PASSWORD');
     $database = getenv('DB_NAME');
     ```

2. **Utilizza Prepared Statements:**
   - I prepared statements proteggono contro attacchi di SQL injection.
   - Esempio:
     ```php
     $stmt = $conn->prepare("SELECT * FROM users WHERE username = ?");
     $stmt->bind_param("s", $username);
     $stmt->execute();
     $result = $stmt->get_result();
     ```

3. **Imposta il Charset Corretto:**
   - Imposta sempre il charset UTF-8 per evitare problemi con caratteri speciali.
   - Esempio:
     ```php
     $conn->set_charset("utf8mb4");
     ```

4. **Chiudi Sempre la Connessione:**
   - Assicurati di chiudere la connessione al database quando non è più necessaria per liberare le risorse.

---

### **Conclusioni**

MySQLi è un'estensione potente e versatile per lavorare con database MySQL/MariaDB in PHP. Offre sia uno stile procedurale che orientato agli oggetti, consentendo ai programmatori di scegliere l'approccio più adatto alle loro esigenze. Seguendo le best practice elencate sopra, puoi garantire una connessione sicura e efficiente al tuo database.

Nella prossima sezione, vedremo come utilizzare **PDO** per una connessione più flessibile e portatile tra diversi tipi di database.